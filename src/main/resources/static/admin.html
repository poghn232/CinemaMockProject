<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>MovieZone | Admin</title>

    <style>
        :root {
            --bg-primary: #020617;
            --bg-elevated: #020617;
            --accent: #f97316;
            --accent-soft: rgba(249, 115, 22, 0.18);
            --accent-strong: rgba(249, 115, 22, 0.45);
            --text-main: #e5e7eb;
            --text-subtle: #9ca3af;
            --border-soft: rgba(148, 163, 184, 0.45);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: radial-gradient(circle at 0 0, rgba(255,255,255,0.06), transparent 55%), radial-gradient(circle at 100% 100%, rgba(37,99,235,0.3), transparent 60%), linear-gradient(135deg, #020617, #030712 50%, #020617); color: var(--text-main); min-height:100vh; }
        .page-shell { max-width: 1320px; margin: 0 auto; padding: 20px 28px 48px; }
        .navbar { display:flex; align-items:center; justify-content:space-between; padding:10px 20px; border-radius:18px; background: radial-gradient(circle at 0 0, rgba(148,163,184,0.35), transparent 58%), rgba(15,23,42,0.96); box-shadow: 0 0 0 1px rgba(148,163,184,0.45), 0 18px 40px rgba(15,23,42,0.95); backdrop-filter: blur(18px); position: sticky; top:12px; z-index:20; }
        .nav-left { display:flex; align-items:center; gap:12px; }
        .nav-logo { width:30px; height:30px; border-radius:999px; background: radial-gradient(circle at 30% 20%, #f97316, #e11d48 55%, #4f46e5); display:flex; align-items:center; justify-content:center; box-shadow:0 0 25px rgba(248,113,113,0.55); font-size:14px; font-weight:700; }
        .nav-title { display:flex; flex-direction:column; line-height:1.1; }
        .nav-title-main { font-weight:700; letter-spacing:0.08em; text-transform:uppercase; font-size:12px; }
        .nav-title-sub { font-size:11px; color:var(--text-subtle); }
        .nav-center { display:flex; align-items:center; gap:6px; margin-left:auto; margin-right:10px; }
        .nav-link { font-size:13px; padding:6px 12px; border-radius:999px; color:var(--text-subtle); text-decoration:none; border:1px solid transparent; transition: all 0.16s ease; cursor:pointer; }
        .nav-link:hover { color:var(--text-main); border-color:rgba(148,163,184,0.6); background:rgba(15,23,42,0.9); }
        .nav-link.active { background: linear-gradient(135deg,#f97316,#ec4899); color:white; border-color:transparent; box-shadow: 0 12px 22px rgba(248,113,113,0.6), 0 0 0 1px rgba(248,113,113,0.7); }
        .nav-right { display:flex; align-items:center; gap:8px; font-size:12px; }
        .nav-username { color:var(--text-subtle); }
        .nav-button { padding:7px 13px; border-radius:999px; border:1px solid rgba(148,163,184,0.7); background:rgba(15,23,42,0.9); color:var(--text-main); font-size:12px; cursor:pointer; transition:all 0.16s ease; }
        .nav-button-primary { border:none; background:linear-gradient(135deg,#f97316,#ec4899); color:white; font-weight:600; }

        .grid { display:grid; grid-template-columns: 1fr 420px; gap:20px; margin-top:26px; }
        .card { background: rgba(15,23,42,0.95); padding:18px; border-radius:14px; border:1px solid var(--border-soft); }
        h2 { font-size:16px; margin-bottom:12px; }
        .users-list { display:flex; flex-direction:column; gap:10px; }
        .user-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:10px; background: rgba(255,255,255,0.02); }
        .user-meta { display:flex; flex-direction:column; }
        .user-name { font-weight:600; }
        .user-email { font-size:12px; color:var(--text-subtle); }

        .toggle { position:relative; width:46px; height:26px; background:rgba(148,163,184,0.12); border-radius:999px; cursor:pointer; padding:3px; }
        .toggle .knob { width:20px; height:20px; border-radius:50%; background:white; transition:transform .16s ease; }
        .toggle.on { background: linear-gradient(135deg,#10b981,#34d399); }
        .toggle.on .knob { transform: translateX(20px); }

        .packs { display:flex; flex-direction:column; gap:12px; }
        .pack-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:10px; background: rgba(255,255,255,0.02); }
        .pack-form { display:flex; flex-direction:column; gap:8px; }
        input[type="text"], input[type="number"] { padding:8px 10px; border-radius:8px; border:1px solid rgba(148,163,184,0.2); background:transparent; color:var(--text-main); }
        .btn { padding:8px 12px; border-radius:8px; border:none; background:var(--accent); color:white; cursor:pointer; }
        .btn.ghost { background:transparent; border:1px solid rgba(148,163,184,0.2); }
        .muted { color:var(--text-subtle); font-size:13px; }

        @media (max-width:1000px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="page-shell">
    <div class="navbar">
        <div class="nav-left">
            <div class="nav-logo">MZ</div>
            <div class="nav-title">
                <div class="nav-title-main">MovieZone Admin</div>
                <div class="nav-title-sub">Manage users & packs</div>
            </div>
        </div>
        <div class="nav-center">
           
            <a class="nav-link active" href="/admin.html">Admin</a>
        </div>
        <div class="nav-right">
            <div class="nav-username">admin</div>
            <button class="nav-button nav-button-primary">Sign out</button>
        </div>
    </div>

    <div class="grid">
        <div>
            <div class="card">
                <h2>Users</h2>
                <div class="muted">Toggle to disable login for an user</div>
                <div id="users" class="users-list" style="margin-top:12px">
                    <!-- users injected here -->
                </div>
            </div>

            <div class="card" style="margin-top:16px">
                <h2>Subscription Packs</h2>
                <div class="muted">Create, edit or remove subscription packs</div>
                <div id="packs" class="packs" style="margin-top:12px">
                    <!-- packs injected -->
                </div>
            </div>
        </div>

        <div>
            <div class="card">
                <h2>Create / Edit Pack</h2>
                <form id="packForm" class="pack-form">
                    <input type="hidden" id="packId" />
                    <input type="text" id="packName" placeholder="Pack name" required />
                    <input id="packPrice" type="number" step="0.01" placeholder="Price" required />
                    <input id="packDays" type="number" placeholder="Duration days" required />
                    <div style="display:flex; gap:8px; margin-top:8px">
                        <button class="btn" id="savePack">Save</button>
                        <button class="btn ghost" id="resetPack" type="button">Reset</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top:16px">
                <h2>Available Packs</h2>
                <div class="muted">Shown to users on the site</div>
                <div id="availablePacks" style="margin-top:12px"></div>
            </div>
        </div>
    </div>
</div>

</script>
<script>
    const api = {
        users: '/api/admin/users',
        packs: '/api/packs'
    };

    // helper that injects Authorization header when token exists
    async function fetchJson(url, opts = {}) {
        const token = localStorage.getItem('token');
        const headers = Object.assign({}, opts.headers || {});
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const res = await fetch(url, Object.assign({}, opts, { headers }));
        if (!res.ok) throw new Error(res.status + ' ' + await res.text());
        // handle empty body
        const txt = await res.text();
        return txt ? JSON.parse(txt) : null;
    }

    function titleCase(s) {
        if (!s) return s;
        return s.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    function formatPrice(v) {
        if (v == null) return '';
        const n = parseFloat(v);
        if (isNaN(n)) return v;
        return n.toFixed(2);
    }

    async function loadUsers() {
        const container = document.getElementById('users');
        container.innerHTML = 'Loading...';
        try {
            const users = await fetchJson(api.users);
            container.innerHTML = '';
            (users || []).forEach(u => {
                const row = document.createElement('div');
                row.className = 'user-row';
                const meta = document.createElement('div'); meta.className='user-meta';
                meta.innerHTML = `<div class="user-name">${u.username} <span class="muted">(${u.role})</span></div><div class="user-email">${u.email}</div>`;
                const toggle = document.createElement('div'); toggle.className='toggle' + (u.enabled ? ' on' : '');
                const knob = document.createElement('div'); knob.className='knob'; toggle.appendChild(knob);
                toggle.addEventListener('click', async () => {
                    try {
                        // optimistic UI
                        toggle.classList.toggle('on');
                        await fetchJson(api.users + '/' + u.userId + '/enabled', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(!u.enabled) });
                        u.enabled = !u.enabled;
                    } catch (e) { alert('Error toggling user: ' + e); loadUsers(); }
                });
                row.appendChild(meta);
                row.appendChild(toggle);
                container.appendChild(row);
            });
        } catch (e) { container.innerHTML = 'Failed to load users'; console.error(e); }
    }

    async function loadPacks() {
        const container = document.getElementById('packs');
        const avail = document.getElementById('availablePacks');
        container.innerHTML = 'Loading...'; avail.innerHTML='';
        try {
            const packs = await fetchJson(api.packs) || [];
            container.innerHTML = '';
            packs.forEach(p => {
                const name = titleCase(String(p.packName || ''));
                const price = formatPrice(p.packPrice);
                const row = document.createElement('div'); row.className='pack-row';
                row.innerHTML = `<div><div style="font-weight:600">${name}</div><div class="muted">${p.durationDays} days - $${price}</div></div>`;
                const actions = document.createElement('div');
                const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='Edit';
                edit.addEventListener('click', () => { document.getElementById('packId').value = p.packId; document.getElementById('packName').value = p.packName; document.getElementById('packPrice').value = p.packPrice; document.getElementById('packDays').value = p.durationDays; });
                const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
                del.addEventListener('click', async () => { if (!confirm('Delete pack?')) return; try { await fetchJson(api.packs + '/' + p.packId, { method: 'DELETE' }); loadPacks(); } catch(e){ alert('Delete failed: '+e); } });
                actions.appendChild(edit); actions.appendChild(del); row.appendChild(actions);
                container.appendChild(row);

                // available
                const a = document.createElement('div'); a.className='pack-row'; a.innerHTML = `<div><div style="font-weight:600">${name}</div><div class="muted">${p.durationDays} days - $${price}</div></div>`;
                avail.appendChild(a);
            });
        } catch (e) { container.innerHTML = 'Failed to load packs'; console.error(e); }
    }

    document.getElementById('packForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const id = document.getElementById('packId').value;
        const dto = { packName: document.getElementById('packName').value, packPrice: parseFloat(document.getElementById('packPrice').value), durationDays: parseInt(document.getElementById('packDays').value) };
        try {
            if (id) {
                await fetchJson(api.packs + '/' + id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(dto) });
            } else {
                await fetchJson(api.packs, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(dto) });
            }
            document.getElementById('packForm').reset(); document.getElementById('packId').value='';
            loadPacks();
        } catch (e) { alert('Save failed: ' + e); }
    });

    document.getElementById('resetPack').addEventListener('click', () => { document.getElementById('packForm').reset(); document.getElementById('packId').value=''; });

    // initial load
    loadUsers(); loadPacks();
</script>
</body>
</html>
